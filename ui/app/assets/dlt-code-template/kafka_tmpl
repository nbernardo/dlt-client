import dlt
from kafka import KafkaConsumer
import certifi

@dlt.source
def kafka_source():
    @dlt.resource(
        write_disposition="merge",
        primary_key="id"
    )
    def messages():
        consumer = KafkaConsumer(
            'test-topic',
            bootstrap_servers=['dlt-c.cloud:9093'],
            security_protocol="SSL",
            ssl_cafile=certifi.where(),
            ssl_check_hostname=True,
            auto_offset_reset="earliest",  
            consumer_timeout_ms=5000
        )
        
        for msg in consumer:
            try:

                data = json.loads(msg.value.decode('utf-8'))
                employees = data.get('employees', [])

                yield from (
                    {
                        **employee,
                        '_kafka_offset': msg.offset,
                        '_kafka_partition': msg.partition,
                        '_kafka_timestamp': msg.timestamp,
                        '_kafka_topic': msg.topic
                    }
                    for employee in employees
                )
                                
            except (json.JSONDecodeError, UnicodeDecodeError) as e:
                print(f"Skipping non-JSON message at offset {msg.offset}: {e}")
                continue
            except Exception as e:
                print(f"Error processing message at offset {msg.offset}: {e}")
                continue
        
        consumer.close()
    
    return messages