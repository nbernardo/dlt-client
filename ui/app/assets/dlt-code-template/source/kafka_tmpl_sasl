import dlt
from kafka import KafkaConsumer
from json import loads

@dlt.source
def data_source():
    @dlt.resource(write_disposition="merge", primary_key=None)
    def messages():
        """ Connect to Kafka broker generates records out of a topic """
        consumer = KafkaConsumer(
            "<topic_name>",
            bootstrap_servers=["<server_addr>"],
            security_protocol="SASL_SSL",
            sasl_mechanism="SCRAM-SHA-512",
            sasl_plain_username="<user_name>",
            sasl_plain_password="<password>", # e.g. __secrets.SECRET_NAME
            auto_offset_reset="earliest",
            consumer_timeout_ms=5000
        )

        if not consumer.bootstrap_connected():
            print(f"RUNTIME_ERROR:Error while connecting to kafka broker. Please check if credentials are correct")
            raise ConnectionError('Error while connecting to kafka broker')
        
        for message in consumer:
            try:
                data = loads(message.value.decode('utf-8'))
                if type(message) == dict:
                    data = message.get("<data_selector>", message)

                yield from (
                    {
                        **record,
                        '_kafka_offset': message.offset,
                        '_kafka_partition': message.partition,
                        '_kafka_timestamp': message.timestamp,
                        '_kafka_topic': message.topic
                    }
                    for record in data
                )
                                
            except (json.JSONDecodeError, UnicodeDecodeError) as e:
                print(f"Skipping non-JSON message at offset {message.offset}: {e}")
                continue
            except Exception as e:
                print(f"Error processing message at offset {message.offset}: {e}")
                continue
        
        consumer.close()
    
    return messages