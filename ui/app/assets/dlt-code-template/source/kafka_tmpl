import dlt
from kafka import KafkaConsumer
import certifi
import json

@dlt.source
def data_source():
    @dlt.resource(
        write_disposition="merge",
        primary_key=None
    )
    def messages():
        consumer = KafkaConsumer(
            "<topic-name>",
            bootstrap_servers=["<server-addr>"],
            security_protocol="SSL",
            ssl_cafile=certifi.where(),
            ssl_check_hostname=True,
            auto_offset_reset="earliest",  
            consumer_timeout_ms=5000
        )
        
        for message in consumer:
            try:

                data = json.loads(message.value.decode('utf-8'))
                if type(message) == dict:
                    data = message.get("<data_selector>", message)

                yield from (
                    {
                        **record,
                        "_kafka_offset": message.offset,
                        "_kafka_partition": message.partition,
                        "_kafka_timestamp": message.timestamp,
                        "_kafka_topic": message.topic
                    }
                    for record in data
                )
                                
            except (json.JSONDecodeError, UnicodeDecodeError) as e:
                print(f"Skipping non-JSON message at offset {message.offset}: {e}")
                continue
            except Exception as e:
                print(f"Error processing message at offset {message.offset}: {e}")
                continue
        
        consumer.close()
    
    return messages