%metadata_section%import dlt
from dlt.sources.filesystem import filesystem, read_csv
%import_from_src%
# Bellow mapping: bucket_url = Bucket.bucket_url, file_glob = Bucket.file_pattern
files = filesystem(bucket_url=%bucket_url%, file_glob=%file_pattern%)
print('Files/Bucket loaded', flush=True)

# Bellow mapping: ppline_dest_table = DuckDBOutput.ppline_dest_table
reader = (files | read_csv()).with_name(%ppline_dest_table%)

if %primary_key% != 'UNDEFINED':
    # Bellow mapping: primary_key = Bucket.primary_key
    reader.apply_hints(primary_key=%primary_key%)

# Usr_folder: The user name sent in the request
# Dbfile_name: This is also mapped to the pipeline_name

%destination_settings%

info = pipeline.run(reader,write_disposition="merge")
print(info, flush=True)