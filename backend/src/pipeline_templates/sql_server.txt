import dlt
from dlt.sources.credentials import ConnectionStringCredentials
from pathlib import Path
import sys


#Adding root folder to allow import  from src
src_path = str(Path(__file__).parent).replace('/destinations/pipeline/facebook_25690644623870471','')
sys.path.insert(0, src_path)
sys.path.insert(0, src_path+'/src')

from src.services.workspace.Workspace import Workspace
from src.services.workspace.SecretManager import SecretManager
from src.utils.SQLDatabase import SQLConnection
from src.utils import SQLServerUtil

# Bellow mapping: namespace = SqlDBComponent.namespace
namespace = %namespace%

# Bellow mapping: connection_name = SqlDBComponent.connection_name
connection_name = %connection_name%

print('connecting to secrets vault')
SecretManager.ppline_connect_to_vault()

print(f'fetching "{connection_name}" secrets for DB connection')
secret = SecretManager.get_db_secret(namespace, connection_name)

connection_string = secret['connection_url']+f'{SQLConnection.get_mssql_driver()}'

# Bellow mapping: source_database = SqlDBComponent.source_database
database_to_connect = %source_database%

credentials = ConnectionStringCredentials(connection_string)

def load_select_tables_from_db():

    dest_folder = Workspace.get_duckdb_path_on_ppline()
    ppline_name = "sql_server_pipeline"
    dest_db = dlt.destinations.duckdb(f'{dest_folder}/facebook_25690644623870471/{ppline_name}.duckdb')
    pipeline = dlt.pipeline(
        pipeline_name=ppline_name,
        destination=dest_db,
        dataset_name="destsqlserver"
    )

    # Bellow mapping: source_tables = SqlDBComponent.source_tables
    tables = %source_tables%

    # Bellow mapping: primary_keys = SqlDBComponent.primary_keys
    tables_pk = %primary_keys%

    source = SQLServerUtil.dynamic_mssql_source(tables, tables_pk, connection_string)
    info = pipeline.run(source)
    print(info)

load_select_tables_from_db()