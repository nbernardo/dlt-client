import json
import sys
from pathlib import Path

#Adding root folder to allow import from src
src_path = str(Path(__file__).parent).replace('/destinations/pipeline/%User_folder%','')
sys.path.insert(0, src_path)
sys.path.insert(0, src_path+'/src')

from src.services.workspace.Workspace import Workspace
from src.services.workspace.SecretManager import referencedSecrets

%template_code%

ppline_name, output_name = %pipeline_name%, %duckdb_dest%
dest_folder = Workspace.get_duckdb_path_on_ppline()
%dest_secret_code%
dest = %destination_string%
print(f"Staring '{ppline_name}' pipeline creation", flush=True)
pipeline = dlt.pipeline(pipeline_name=ppline_name,destination=dest,dataset_name=output_name)

print(f'Fetching data from datasource', flush=True)
data = data_source()
print(f"Running the pipeline '{ppline_name}'", flush=True)

try:
    load_info = pipeline.run(data)
    print(load_info, flush=True)
except Exception as err:
    print(f'RUNTIME_ERROR:Runtime Pipeline error: {err}')