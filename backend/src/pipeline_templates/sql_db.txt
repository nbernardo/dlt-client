import dlt
from dlt.sources.credentials import ConnectionStringCredentials
from dlt.sources.sql_database import sql_database, sql_table
from os import getenv as env
from pathlib import Path
import sys

#Adding root folder to allow import  from src
src_path = str(Path(__file__).parent).replace('/destinations/pipeline/%User_folder%','')
sys.path.insert(0, src_path)
sys.path.insert(0, src_path+'/src')

from src.services.workspace.Workspace import Workspace
from src.services.workspace.SecretManager import SecretManager

vault_url = env('HASHICORP_HOST')
vault_token = env('HASHICORP_TOKEN')
vault_crt_path = False \
    if str(env('HASHICORP_CERTIF_PATH','false')).lower() == 'false'\
    else env('HASHICORP_CERTIF_PATH')

params = { 
    'vault_url': vault_url, 
    'vault_token': vault_token,
    'vault_crt_path': vault_crt_path
}

# Bellow mapping: namespace = SqlDBComponent.namespace
namespace = %namespace%

# Bellow mapping: connection_name = SqlDBComponent.connection_name
connection_name = %connection_name%

SecretManager.connect_to_vault(params)
secret = SecretManager.get_db_secret(namespace, connection_name)
connection_string = secret['connection_url']

# Bellow mapping: schema = SqlDBComponent.source_database
database_to_connect = %source_database%

# Bellow mapping: schema = SqlDBComponent.source_dbengine
credentials = ConnectionStringCredentials(connection_string)

def load_select_tables_from_db():
    dest_folder = Workspace.get_duckdb_path_on_ppline()
    ppline_name = %pipeline_name%
    dest_db = dlt.destinations.duckdb(f'{dest_folder}/%User_folder%/{ppline_name}.duckdb')
    pipeline = dlt.pipeline(
        pipeline_name=ppline_name,
        destination=dest_db,
        # Bellow mapping: schema = DuckDBOutput.duckdb_dest
        dataset_name=%duckdb_dest%
    )

    # Bellow mapping: schema = SqlDBComponent.source_tables
    tables = %source_tables%

    # Bellow mapping: schema = SqlDBComponent.primary_keys
    tables_pk = %primary_keys%

    source = sql_database(table_names=tables, credentials=credentials)

    for idx in range(len(tables)):
        getattr(source, tables[idx])\
            .apply_hints(primary_key=tables_pk[idx])

    info = pipeline.run(source)
    print(info)

load_select_tables_from_db()